<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3DÊµ∑Ê¥ãËø∑Ë∑Ø„Ç≤„Éº„É†Ôºà„ÉÜ„Çπ„ÉàÁâàÔºâ</title>
    <style>
        :root {
            --primary-blue: #00bcd4;
            --deep-blue: #006064;
            --ocean-green: #26c6da;
            --white: #ffffff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--deep-blue) 0%, var(--primary-blue) 100%);
            color: var(--white);
            overflow: hidden;
        }
        
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        .ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid var(--ocean-green);
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid var(--ocean-green);
        }
        
        .maze-info {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid var(--ocean-green);
            text-align: center;
        }
        
        #gameCanvas {
            display: block;
            cursor: crosshair;
        }
        
        .start-button {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--ocean-green) 100%);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 188, 212, 0.4);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="ui-overlay">
            <h3>üåä 3DÊµ∑Ê¥ãËø∑Ë∑Ø</h3>
            <div>ÊôÇÈñì: <span id="timer">00:00</span></div>
            <div>‰ΩçÁΩÆ: <span id="position">„Çπ„Çø„Éº„Éà</span></div>
            <button class="start-button" id="startBtn">Êñ∞„Åó„ÅÑËø∑Ë∑Ø</button>
        </div>
        
        <div class="controls">
            <h4>Êìç‰ΩúÊñπÊ≥ï</h4>
            <div>üñ±Ô∏è „Éû„Ç¶„Çπ: Ë¶ñÁÇπÁßªÂãï</div>
            <div>‚å®Ô∏è WASD: ÁßªÂãï</div>
            <div>üéØ ÁõÆÊ®ô: Ëµ§„ÅÑ„Ç¥„Éº„É´„ÇíË¶ã„Å§„Åë„Çà„ÅÜÔºÅ</div>
        </div>
        
        <div class="maze-info">
            <h4>üèÜ „ÉÅ„É£„É¨„É≥„Ç∏</h4>
            <div>Ëø∑Ë∑Ø„Çí„ÇØ„É™„Ç¢„Åó„Å¶</div>
            <div>Êµ∑Â≠¶„Éû„Çπ„Çø„Éº„Å´„Å™„Çç„ÅÜÔºÅ</div>
        </div>
        
        <canvas id="gameCanvas"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        class Maze3DGame {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.player = null;
                this.maze = [];
                this.mazeSize = 11; // Â•áÊï∞„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã
                this.wallHeight = 3;
                this.playerSpeed = 0.1;
                this.gameStartTime = null;
                this.gameTimer = null;
                this.isGameActive = false;
                
                // „Éó„É¨„Ç§„É§„Éº„ÅÆ‰ΩçÁΩÆ
                this.playerPos = { x: 1, z: 1 };
                this.goalPos = { x: this.mazeSize - 2, z: this.mazeSize - 2 };
                
                this.init();
            }
            
            init() {
                this.setupScene();
                this.generateMaze();
                this.createMaze3D();
                this.setupPlayer();
                this.setupLighting();
                this.setupControls();
                this.animate();
                
                document.getElementById('startBtn').addEventListener('click', () => this.startNewGame());
            }
            
            setupScene() {
                // „Ç∑„Éº„É≥‰ΩúÊàê
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x001122);
                this.scene.fog = new THREE.Fog(0x001122, 10, 30);
                
                // „Ç´„É°„É©‰ΩúÊàê
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                
                // „É¨„É≥„ÉÄ„É©„Éº‰ΩúÊàê
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: document.getElementById('gameCanvas'),
                    antialias: true 
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            }
            
            generateMaze() {
                // Ëø∑Ë∑ØÂàùÊúüÂåñÔºàÂÖ®„Å¶ÈÄöË∑ØÔºâ
                this.maze = [];
                for (let i = 0; i < this.mazeSize; i++) {
                    this.maze[i] = [];
                    for (let j = 0; j < this.mazeSize; j++) {
                        this.maze[i][j] = 0; // 0 = ÈÄöË∑Ø, 1 = Â£Å
                    }
                }
                
                // „Ç∑„É≥„Éó„É´„Å™Áõ¥Á∑öËø∑Ë∑Ø„Éë„Çø„Éº„É≥„Çí‰ΩúÊàê
                this.generateSimpleMaze();
            }
            
            generateSimpleMaze() {
                // Â§ñÂë®„ÇíÂ£Å„Å´„Åô„Çã
                for (let i = 0; i < this.mazeSize; i++) {
                    this.maze[0][i] = 1; // ‰∏ä„ÅÆÂ£Å
                    this.maze[this.mazeSize - 1][i] = 1; // ‰∏ã„ÅÆÂ£Å
                    this.maze[i][0] = 1; // Â∑¶„ÅÆÂ£Å
                    this.maze[i][this.mazeSize - 1] = 1; // Âè≥„ÅÆÂ£Å
                }
                
                // Áõ¥Á∑öÁöÑ„Å™Â£Å„Éë„Çø„Éº„É≥„Çí‰ΩúÊàê
                for (let i = 2; i < this.mazeSize - 2; i += 4) {
                    for (let j = 1; j < this.mazeSize - 1; j++) {
                        if (j !== 2 && j !== this.mazeSize - 3) { // ÈÄöË∑Ø„ÇíÊÆã„Åô
                            this.maze[i][j] = 1;
                        }
                    }
                }
                
                // Á∏¶„ÅÆÁõ¥Á∑öÂ£Å
                for (let j = 2; j < this.mazeSize - 2; j += 4) {
                    for (let i = 1; i < this.mazeSize - 1; i++) {
                        if (i !== 2 && i !== this.mazeSize - 3) { // ÈÄöË∑Ø„ÇíÊÆã„Åô
                            this.maze[i][j] = 1;
                        }
                    }
                }
                
                // „Çπ„Çø„Éº„Éà„Å®„Ç¥„Éº„É´Âú∞ÁÇπ„ÇíÁ¢∫‰øù
                this.maze[1][1] = 0; // „Çπ„Çø„Éº„Éà
                this.maze[this.mazeSize - 2][this.mazeSize - 2] = 0; // „Ç¥„Éº„É´
                
                // „Çπ„Çø„Éº„Éà„Å®„Ç¥„Éº„É´Âë®Ëæ∫„ÇíÂ∞ë„ÅóÈñã„Åë„Çã
                this.maze[1][2] = 0;
                this.maze[2][1] = 0;
                this.maze[this.mazeSize - 2][this.mazeSize - 3] = 0;
                this.maze[this.mazeSize - 3][this.mazeSize - 2] = 0;
            }
            
            
            createMaze3D() {
                // Êó¢Â≠ò„ÅÆËø∑Ë∑Ø„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§
                const existingWalls = this.scene.children.filter(child => child.userData.type === 'wall');
                existingWalls.forEach(wall => this.scene.remove(wall));
                
                // Â£Å„ÅÆ„Éû„ÉÜ„É™„Ç¢„É´Ôºà„ÉØ„Ç§„É§„Éº„Éï„É¨„Éº„É†Ôºâ
                const wallMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0x00ffff,
                    wireframe: true,
                    transparent: true,
                    opacity: 0.8
                });
                
                const wallGeometry = new THREE.BoxGeometry(1, this.wallHeight, 1);
                
                // Ëø∑Ë∑Ø„Çí3D„ÅßÊßãÁØâ
                for (let x = 0; x < this.mazeSize; x++) {
                    for (let z = 0; z < this.mazeSize; z++) {
                        if (this.maze[x][z] === 1) {
                            const wall = new THREE.Mesh(wallGeometry, wallMaterial);
                            wall.position.set(x - this.mazeSize/2, this.wallHeight/2, z - this.mazeSize/2);
                            wall.userData.type = 'wall';
                            this.scene.add(wall);
                        }
                    }
                }
                
                // „Ç¥„Éº„É´‰ΩúÊàê
                const goalGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.5, 8);
                const goalMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0xff0000,
                    wireframe: true 
                });
                
                if (this.goal) {
                    this.scene.remove(this.goal);
                }
                
                this.goal = new THREE.Mesh(goalGeometry, goalMaterial);
                this.goal.position.set(
                    this.goalPos.x - this.mazeSize/2, 
                    0.25, 
                    this.goalPos.z - this.mazeSize/2
                );
                this.goal.userData.type = 'goal';
                this.scene.add(this.goal);
                
                // „Ç¥„Éº„É´„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                this.goal.rotation.y = 0;
            }
            
            setupPlayer() {
                // „Éó„É¨„Ç§„É§„ÉºÔºà„Ç´„É°„É©Ôºâ„ÅÆÂàùÊúü‰ΩçÁΩÆ
                this.camera.position.set(
                    this.playerPos.x - this.mazeSize/2, 
                    1.6, 
                    this.playerPos.z - this.mazeSize/2
                );
                this.camera.lookAt(0, 1.6, 1);
            }
            
            setupLighting() {
                // Áí∞Â¢ÉÂÖâ
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                // „Éó„É¨„Ç§„É§„Éº„Å´„Å§„ÅÑ„Å¶„Åè„Çã„É©„Ç§„Éà
                this.playerLight = new THREE.PointLight(0x00ffff, 1, 10);
                this.playerLight.position.copy(this.camera.position);
                this.scene.add(this.playerLight);
            }
            
            setupControls() {
                this.keys = {};
                
                window.addEventListener('keydown', (event) => {
                    this.keys[event.code] = true;
                });
                
                window.addEventListener('keyup', (event) => {
                    this.keys[event.code] = false;
                });
                
                // „Éû„Ç¶„ÇπÂà∂Âæ°
                let mouseX = 0, mouseY = 0;
                let isMouseDown = false;
                
                document.addEventListener('mousemove', (event) => {
                    if (isMouseDown) {
                        const deltaX = event.clientX - mouseX;
                        const deltaY = event.clientY - mouseY;
                        
                        this.camera.rotation.y -= deltaX * 0.002;
                        this.camera.rotation.x -= deltaY * 0.002;
                        this.camera.rotation.x = Math.max(-Math.PI/3, Math.min(Math.PI/3, this.camera.rotation.x));
                    }
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                });
                
                document.addEventListener('mousedown', () => isMouseDown = true);
                document.addEventListener('mouseup', () => isMouseDown = false);
                
                // „É™„Çµ„Ç§„Ç∫ÂØæÂøú
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            
            updatePlayerMovement() {
                if (!this.isGameActive) return;
                
                const direction = new THREE.Vector3();
                const right = new THREE.Vector3();
                
                this.camera.getWorldDirection(direction);
                right.crossVectors(direction, this.camera.up);
                
                direction.y = 0;
                right.y = 0;
                direction.normalize();
                right.normalize();
                
                let newPosition = this.camera.position.clone();
                
                if (this.keys['KeyW']) {
                    newPosition.add(direction.multiplyScalar(this.playerSpeed));
                }
                if (this.keys['KeyS']) {
                    newPosition.add(direction.multiplyScalar(-this.playerSpeed));
                }
                if (this.keys['KeyA']) {
                    newPosition.add(right.multiplyScalar(-this.playerSpeed));
                }
                if (this.keys['KeyD']) {
                    newPosition.add(right.multiplyScalar(this.playerSpeed));
                }
                
                // Â£Å„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
                if (this.canMoveTo(newPosition)) {
                    this.camera.position.copy(newPosition);
                    this.playerLight.position.copy(this.camera.position);
                    
                    // ‰ΩçÁΩÆÊõ¥Êñ∞
                    const gridX = Math.round(newPosition.x + this.mazeSize/2);
                    const gridZ = Math.round(newPosition.z + this.mazeSize/2);
                    document.getElementById('position').textContent = `(${gridX}, ${gridZ})`;
                    
                    // „Ç¥„Éº„É´Âà§ÂÆö
                    this.checkGoal();
                }
            }
            
            canMoveTo(position) {
                const gridX = Math.round(position.x + this.mazeSize/2);
                const gridZ = Math.round(position.z + this.mazeSize/2);
                
                if (gridX < 0 || gridX >= this.mazeSize || gridZ < 0 || gridZ >= this.mazeSize) {
                    return false;
                }
                
                return this.maze[gridX][gridZ] === 0;
            }
            
            checkGoal() {
                const distance = this.camera.position.distanceTo(this.goal.position);
                if (distance < 1) {
                    this.gameWin();
                }
            }
            
            gameWin() {
                this.isGameActive = false;
                clearInterval(this.gameTimer);
                
                const endTime = Date.now();
                const totalTime = Math.floor((endTime - this.gameStartTime) / 1000);
                const minutes = Math.floor(totalTime / 60);
                const seconds = totalTime % 60;
                
                alert(`üéâ „Ç¥„Éº„É´Âà∞ÈÅîÔºÅ\nÊôÇÈñì: ${minutes}:${seconds.toString().padStart(2, '0')}\n\nÊñ∞„Åó„ÅÑËø∑Ë∑Ø„Å´ÊåëÊà¶„Åó„Åæ„Åô„ÅãÔºü`);
            }
            
            startNewGame() {
                this.isGameActive = true;
                this.gameStartTime = Date.now();
                
                this.generateMaze();
                this.createMaze3D();
                this.setupPlayer();
                
                // „Çø„Ç§„Éû„ÉºÈñãÂßã
                this.gameTimer = setInterval(() => {
                    if (this.isGameActive) {
                        const elapsed = Math.floor((Date.now() - this.gameStartTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        document.getElementById('timer').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
                
                document.getElementById('position').textContent = '„Çπ„Çø„Éº„Éà';
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                this.updatePlayerMovement();
                
                // „Ç¥„Éº„É´„ÅÆÂõûËª¢„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                if (this.goal) {
                    this.goal.rotation.y += 0.02;
                }
                
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        // „Ç≤„Éº„É†ÈñãÂßã
        window.addEventListener('DOMContentLoaded', () => {
            new Maze3DGame();
        });
    </script>
</body>
</html>